<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>L√úIS | Commission Price Calculator</title>
    
    <style>
        /* ================================================= */
        /* BASE STYLING & COLOR VARIABLES */
        /* ================================================= */
        :root {
            /* --- COLOR PALETTE (Requested: White Background + #d4ff79 & #8291e1) --- */
            --primary-accent: #d4ff79; /* Light Green - Buttons, Highlights */
            --secondary-accent: #8291e1; /* Light Blue/Violet - Text/Borders/Secondary Highlights */
            
            --bg-base: #fff; /* Main Page Background */
            --card-base: #fff; /* Card/Panel remains white */
            --text-dark: #000;
            --text-light: #fff;
            --text-gray: #4a4a4a;
            --gray-light: #f4f4f4; /* Light background for unselected options */

            --card-radius: 16px;
            --border-radius-lg: 50px;
            --spacing-lg: 80px;
            --spacing-md: 40px;
            
            --accent-text: #000; /* Black text on primary accent background (#d4ff79) */
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* FONTS (Assuming font files are available in ./fonts/) */
        @font-face { font-family: 'Athletics'; font-style: normal; font-weight: 400; font-display: swap; src: url('./fonts/Athletics Regular.otf') format('opentype'); }
        @font-face { font-family: 'Athletics'; font-style: normal; font-weight: 500; font-display: swap; src: url('./fonts/Athletics Medium.otf') format('opentype'); }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: var(--bg-base); /* White Background */
            font-family: 'Athletics', Arial, sans-serif;
            color: var(--text-dark); 
            min-height: 100vh;
        }
        a { text-decoration: none; color: var(--text-dark); transition: color 0.3s ease; }

        /* NAVBAR STYLING - Adjusted for White Background */
        .navbar { 
            position: sticky; top: 30px; left: 0; width: 100%; display: flex; 
            justify-content: space-between; align-items: center; padding: 0 var(--spacing-md); z-index: 200; 
        }
        /* LOGO COLOR CHANGED TO BLACK */
        .luis-logo { font-size: 2.5rem; font-weight: 500; color: var(--text-dark); } 
        
        .glass-island { 
            display: flex; gap: 30px; padding: 15px 30px; border-radius: var(--border-radius-lg); 
            background: rgba(255, 255, 255, 0.7); /* Lighter glass effect */
            backdrop-filter: blur(10px) saturate(180%); -webkit-backdrop-filter: blur(10px) saturate(180%); 
            border: 1px solid rgba(130, 145, 225, 0.4); /* Border based on secondary accent */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
        }
        .glass-island a { color: var(--text-dark); text-decoration: none; font-weight: 400; font-size: 1.1rem; padding: 5px 0; }
        .hamburger-menu { width: 30px; height: 30px; display: flex; flex-direction: column; justify-content: space-around; cursor: pointer; padding: 5px 0; }
        .hamburger-menu span { display: block; width: 100%; height: 2px; background-color: var(--text-dark); } /* Black burger lines */
        
        /* CALCULATOR LAYOUT & CONTAINER */
        .request-container { max-width: 1000px; margin: 0 auto; padding: 80px var(--spacing-lg) var(--spacing-lg); }
        .right-panel { 
            width: 100%; padding: 40px; border-radius: 25px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); /* Stronger shadow for floating effect on white BG */
            background: var(--card-base); 
            border: none; /* Removed border */
            display: flex; flex-direction: column;
        }
        
        /* ‚≠êÔ∏è MALAKING GREETING STYLE */
        .main-greeting {
            font-size: 4rem; 
            font-weight: 500; 
            text-align: center;
            margin-bottom: 50px;
            color: var(--secondary-accent);
            line-height: 1.1;
        }
        
        /* --- Calculator Specific Styles --- */
        .header { margin-bottom: var(--spacing-md); }
        .header h1 { font-size: 2.2rem; font-weight: 500; color: var(--text-dark); margin-bottom: 5px; }
        .header p { color: var(--text-gray); font-size: 1.1rem; }

        .step-container { 
            position: relative; min-height: 350px; flex-grow: 1; padding-bottom: var(--spacing-md); 
            overflow: hidden; /* Important for animation */
        }
        
        /* ‚≠êÔ∏è STEP ANIMATION STYLES (Slide-in/Slide-out) */
        .step { 
            position: absolute; width: 100%; top: 0; left: 0;
            visibility: hidden; 
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
            padding: var(--spacing-md) 0; 
        }
        
        /* Default state (Hidden, off-screen right) */
        .step:not(.active) {
            opacity: 0;
            transform: translateX(100%);
        }

        /* Active state (Visible, on-screen center) */
        .step.active { 
            opacity: 1; 
            visibility: visible; 
            position: relative; 
            transform: translateX(0);
        }
        
        /* Animation class for slide-out left (used when going NEXT) */
        .step.slide-out-left {
            transform: translateX(-100%);
            opacity: 0;
            visibility: hidden;
        }

        /* Animation class for slide-in right (used when going PREVIOUS) */
        .step.slide-in-right {
            transform: translateX(0); /* Reverts to center */
            opacity: 1;
            visibility: visible;
        }

        .step h3 { font-size: 1.5rem; font-weight: 500; margin-bottom: var(--spacing-md); }
        
        /* Choice Options - PILL STYLE */
        .options-grid { display: flex; flex-wrap: wrap; gap: 12px; }
        .choice-option {
            background-color: var(--card-base); 
            border: 2px solid var(--secondary-accent); /* Border with secondary accent color */
            padding: 12px 20px;
            border-radius: 50px; /* Pill shape */
            cursor: pointer; transition: all 0.2s ease; font-size: 1rem;
            font-weight: 400; user-select: none;
            color: var(--text-dark);
        }
        .choice-option:hover { background-color: var(--gray-light); } /* Slight hover effect */
        .choice-option.selected {
            background-color: var(--primary-accent); 
            color: var(--accent-text); 
            border-color: var(--primary-accent);
            font-weight: 500;
        }

        /* Dropdown/Select Styling */
        .styled-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 20px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23333333'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            cursor: pointer;
        }
        .styled-select:focus { outline: none; border-color: var(--secondary-accent); }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; }


        /* Navigation & Price Display */
        .navigation { 
            display: flex; justify-content: space-between; margin-top: auto; 
            padding-top: var(--spacing-md); border-top: 1px solid var(--gray-light); width: 100%; 
        }
        
        /* ‚≠êÔ∏è NAVIGATION BUTTON STYLE (Minimalist Black/White) */
        .nav-button {
            background-color: var(--card-base); 
            color: var(--text-dark); 
            border: 2px solid var(--text-dark); /* Black border */
            padding: 12px 25px; border-radius: 50px; cursor: pointer;
            font-size: 1rem; font-weight: 500; transition: all 0.2s;
        }
        .nav-button:hover { 
            background-color: var(--text-dark); 
            color: var(--text-light);
        } 
        .nav-button:disabled { 
            background-color: #ccc; 
            border-color: #ccc; 
            cursor: not-allowed; 
            color: #555; 
        }

        .total-price-display { text-align: center; padding: 30px 0; }
        #final-price-value {
            font-size: 3rem; font-weight: 500; color: var(--secondary-accent); /* Use secondary accent for total price */
            display: block; margin-bottom: 20px;
        }
        
        /* Input Styles */
        .form-input {
            width: 100%; border: 1px solid #ccc; padding: 15px; font-size: 1rem;
            font-family: 'Athletics', sans-serif; margin-bottom: 20px; resize: vertical;
            border-radius: 8px; transition: border-color 0.3s;
        }
        .form-input:focus { outline: none; border-color: var(--secondary-accent); } 
        .file-upload-wrapper {
            border: 1px dashed var(--secondary-accent); /* Dashed border with accent color */
            padding: 15px; border-radius: 8px; margin-bottom: 20px;
            text-align: center; cursor: pointer;
        }
        .file-upload-wrapper:hover { border-color: var(--primary-accent); } /* Primary accent on hover */

        /* RECEIPT ANIMATION STYLES */
        @keyframes printAnimation {
            0% { transform: translateY(100%); opacity: 0; }
            50% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        .receipt-area {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 50px 0; text-align: center;
        }

        .receipt-loading {
            font-size: 1.5rem; font-weight: 500; color: var(--secondary-accent); 
            animation: pulse 1.5s infinite; margin-bottom: 30px;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .final-receipt-paper {
            background: var(--card-base); border: 1px solid #eee; border-radius: 8px;
            width: 100%; max-width: 400px;
            padding: 30px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(100%); opacity: 0;
            animation: printAnimation 1.5s ease-out forwards;
        }
        .receipt-header {
            font-size: 1.5rem; font-weight: 500; border-bottom: 2px dashed #ccc;
            padding-bottom: 10px; margin-bottom: 15px;
        }
        .receipt-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 1rem; }
        .receipt-item-title { font-weight: 400; color: #555; }
        .receipt-total { border-top: 2px solid var(--text-dark); margin-top: 15px; padding-top: 10px; font-size: 1.4rem; font-weight: 500; }
        .receipt-note-box { background: var(--gray-light); padding: 10px; border-radius: 5px; margin-top: 15px; font-size: 0.9rem; text-align: left; }


        /* Responsive Design */
        @media (max-width: 900px) {
            :root { --spacing-lg: 30px; --spacing-md: 20px; }
            .navbar { padding: 20px var(--spacing-md); }
            .request-container { padding: 20px var(--spacing-lg) 40px; }
            .right-panel { padding: 20px; }
            .navigation { flex-direction: column; gap: 10px; }
            .nav-button { width: 100%; text-align: center; }
            .receipt-area { padding: 20px 0; }
            .main-greeting { font-size: 2.5rem; margin-bottom: 30px; }
        }
    </style>
</head>
<body>

    <header class="navbar">
        <div class="luis-logo">L√úIS</div>
        <nav class="glass-island">
            <a href="index.html">Home</a> 
            <a href="portfolio.html">Portfolio</a> 
            <a href="request.html">Request</a> 
            <a href="#footer">Contact</a> 
        </nav>
        <div class="hamburger-menu" id="hamburger-open">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </header>

    <div class="request-container">
        
        <h2 class="main-greeting">Let's calculate your dream art project.</h2>

        <div class="right-panel">
            
            <div class="header">
                <h1>Commission Calculator</h1>
                <p>Find out how much your custom artwork will cost before ordering.</p>
            </div>
        
            <form id="price-calculator-form" onsubmit="event.preventDefault(); showStep(getNextStep(currentStep, selections.medium), 'next');">
                <div class="step-container">
                    
                    <div class="step active" data-step="1">
                        <h3>1. Choose Medium</h3>
                        <div class="options-grid">
                            <div class="choice-option" data-type="medium" data-value="Digital">Digital Art (Graphic Design)</div>
                            <div class="choice-option" data-type="medium" data-value="Traditional">Traditional Art (Drawing)</div>
                        </div>
                    </div>

                    <div class="step" data-step="2">
                        <h3>2. Paper Size (Acid-Free Paper)</h3>
                        <div class="options-grid">
                            <div class="choice-option" data-type="paper_size" data-value="A5" data-price="0">A5 (Standard, No additional cost)</div>
                            <div class="choice-option" data-type="paper_size" data-value="A3" data-price="50">A3 (+‚Ç±50)</div>
                        </div>
                    </div>

                    <div class="step" data-step="3">
                        <h3>3. Digital Art Type (Brutalist)</h3>
                        <p style="margin-bottom: 20px; color: var(--text-gray);">Delivery via Google Drive. Pure Graphic Design/Vector.</p>
                        <div class="options-grid">
                            <div class="choice-option" data-type="digital_type" data-value="Poster" data-price="3000">Poster (‚Ç±3,000)</div>
                            <div class="choice-option" data-type="digital_type" data-value="Logo" data-price="1000">Logo (‚Ç±1,000)</div>
                        </div>
                    </div>
        
                    <div class="step" data-step="4">
                        <h3>4. Art Style (Select an Art Style)</h3>
                        <div class="options-grid">
                            <div class="choice-option" data-type="style" data-value="Realistic" data-price="1000">Realistic (+‚Ç±1,000)</div>
                            <div class="choice-option" data-type="style" data-value="Anime" data-price="200">Anime (+‚Ç±200)</div>
                            <div class="choice-option" data-type="style" data-value="Cartoon" data-price="200">Cartoon (+‚Ç±200)</div>
                            <div class="choice-option" data-type="style" data-value="Chibi" data-price="150">Chibi (+‚Ç±150)</div>
                        </div>
                    </div>
        
                    <div class="step" data-step="5">
                        <h3>5. Composition (Body Shot)</h3>
                        <div class="options-grid" id="composition-options">
                            <div class="choice-option" data-type="comp" data-value="Headshot">Headshot (Free)</div>
                            <div class="choice-option" data-type="comp" data-value="Bust">Bust (+Price Varies)</div>
                            <div class="choice-option" data-type="comp" data-value="Half Body">Half Body (+Price Varies)</div>
                            <div class="choice-option" data-type="comp" data-value="Full Body">Full Body (+Price Varies)</div>
                        </div>
                    </div>
        
                    <div class="step" data-step="6">
                        <h3>6. Finish</h3>
                        <div class="options-grid">
                            <div class="choice-option" data-type="finish" data-value="Lineart" data-price="0">Lineart (Free)</div>
                            <div class="choice-option" data-type="finish" data-value="Shaded" data-price="50">Shaded (+‚Ç±50)</div>
                            <div class="choice-option" data-type="finish" data-value="Colored" data-price="100">Colored (+‚Ç±100)</div>
                        </div>
                    </div>
                    
                    <div class="step" data-step="7">
                        <h3>7. Background</h3>
                        <div class="options-grid">
                            <div class="choice-option" data-type="bg" data-value="None" data-price="0">No Background / Solid (Free)</div>
                            <div class="choice-option" data-type="bg" data-value="Simple" data-price="150">Simple (+‚Ç±150)</div>
                            <div class="choice-option" data-type="bg" data-value="Detailed">Detailed (+‚Ç±250 to ‚Ç±450)</div>
                        </div>
                        
                        <div id="bg-slider-group" class="input-group" style="display:none; margin-top: 20px;">
                            <label for="bg-slider">Choose Detailed BG Price:</label>
                            <input type="range" id="bg-slider" min="250" max="450" step="50" value="250">
                            <div style="text-align: center; font-weight: 500;">Current Cost: ‚Ç±<span id="bg-slider-value">250</span></div>
                        </div>
                    </div>
        
                    <div class="step" data-step="8">
                        <h3>8. Extras</h3>
                        
                        <div class="input-group" style="margin-bottom: 20px;">
                            <label for="extra-char-select">Extra Character(s) Composition (Base Price Varies)</label>
                            <select id="extra-char-select" class="styled-select" data-type="extra_char_comp">
                                <option value="0" selected>0 (No Extra Character)</option>
                                <option value="Headshot_1">1 Extra Character (Headshot)</option>
                                <option value="Bust_1">1 Extra Character (Bust)</option>
                                <option value="Half Body_1">1 Extra Character (Half Body)</option>
                                <option value="Full Body_1">1 Extra Character (Full Body)</option>
                                <option value="Headshot_2">2 Extra Characters (Headshot)</option>
                                <option value="Bust_2">2 Extra Characters (Bust)</option>
                                <option value="Half Body_2">2 Extra Characters (Half Body)</option>
                                <option value="Full Body_2">2 Extra Characters (Full Body)</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label>Pet / Object (+‚Ç±100 to ‚Ç±200)</label>
                            <div class="options-grid">
                                <div class="choice-option" data-type="extra_pet" data-value="Pet_Object_Base" data-price="100">Yes, with Pet/Object (+‚Ç±100)</div>
                            </div>
                            <div id="pet-slider-group" class="input-group" style="display:none; margin-top: 20px;">
                                <label for="pet-slider">Choose Pet/Object Price (Complexity):</label>
                                <input type="range" id="pet-slider" min="100" max="200" step="25" value="100">
                                <div style="text-align: center; font-weight: 500;">Current Cost: ‚Ç±<span id="pet-slider-value">100</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="step" data-step="9">
                        <h3>9. Final Details & Payment</h3>
                        
                        <div class="total-price-display">
                            <span style="font-size: 1.2rem; display: block;">Current Estimated Price:</span>
                            <strong id="final-price-value">‚Ç±0</strong>
                        </div>
                        
                        <label style="font-weight: 500;">Mode of Payment</label>
                        <div class="options-grid" style="margin-bottom: 20px;">
                            <div class="choice-option" data-type="payment" data-value="GCash">GCash (Local)</div>
                            <div class="choice-option" data-type="payment" data-value="PayPal">PayPal (International, +transaction fee)</div>
                        </div>
                        
                        <label style="font-weight: 500;">Reference Image Upload (Optional)</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="reference-upload" class="form-input" style="display: none;" accept="image/*, .zip, .rar">
                            <p id="upload-label">Click here to upload reference file</p>
                        </div>
                        
                        <label for="notes" style="font-weight: 500;">Notes / Description (Optional)</label>
                        <textarea id="notes" class="form-input" placeholder="Please describe your character, pose, color details, and any other notes." rows="5"></textarea>
                    </div>

                    <div class="step" data-step="10">
                        <h3>Commission Confirmation</h3>
                        <div class="receipt-area">
                            <div class="receipt-loading">Your receipt is printing, please wait...</div>
                            <div class="final-receipt-paper" id="final-receipt-content" style="display: none;">
                                </div>
                        </div>
                    </div>
                    
                </div>
                
                <div class="navigation">
                    <button type="button" id="prev-btn" class="nav-button" disabled>‚Üê Previous</button>
                    <div style="font-size: 1.1rem; align-self: center;">Step <span id="step-number">1</span></div>
                    <button type="submit" id="next-btn" class="nav-button">Next ‚Üí</button>
                </div>
                
            </form>

        </div>
        
    </div>
    
    <script>
    // Price rules for non-composition items (Style, Finish, Extras Base)
    const priceRules = {
        'Traditional_Base': 0, 
        'Realistic': 1000, 'Anime': 200, 'Cartoon': 200, 'Chibi': 150,
        'A3_ADDON': 50, 
        
        // Extra Character Base Price (Composition is calculated by function below)
        'Extra_Base': 150, 
        
        // Finish Prices
        'Colored': 100, 'Shaded': 50,

        // Digital Art Rules
        'Poster': 3000, 'Logo': 1000 // ‚úÖ BINAGO NA SA 3000 PESOS
    };
    
    let selections = {
        medium: null, 
        paper_size: null, 
        digital_type: null, 
        // Traditional Art Selections
        style: null, comp: 'Headshot', finish: 'Lineart', bg: 'None', 
        bg_detailed_price: 250, 
        // Extra Character changed to dropdown value
        extra_char_type_count: '0', 
        pet_object: false, pet_object_price: 100,
        // Final Steps
        payment: null, notes: '', referenceFile: null
    };
    
    const totalSteps = 10; 
    let currentStep = 1;

    // DOM Elements (Initialized later in the script)
    const steps = document.querySelectorAll('.step');
    const stepNumberSpan = document.getElementById('step-number');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const allOptions = document.querySelectorAll('.choice-option');
    const bgSliderGroup = document.getElementById('bg-slider-group');
    const bgSlider = document.getElementById('bg-slider');
    const bgSliderValue = document.getElementById('bg-slider-value');
    const petSliderGroup = document.getElementById('pet-slider-group');
    const petSlider = document.getElementById('pet-slider');
    const petSliderValue = document.getElementById('pet-slider-value');
    const referenceUpload = document.getElementById('reference-upload');
    const uploadLabel = document.getElementById('upload-label');
    const notesInput = document.getElementById('notes');
    const receiptLoading = document.querySelector('.receipt-loading');
    const finalReceiptPaper = document.getElementById('final-receipt-content');
    const finalPriceDisplay = document.getElementById('final-price-value');
    const extraCharSelect = document.getElementById('extra-char-select');


    // --- Core Functions ---
    
    function getTraditionalBasePrice() {
        return priceRules['Traditional_Base'];
    }

    // üü¢ NEW FUNCTION: Direct calculation for Composition Prices
    function getPriceForComposition(comp, isRealistic) {
        if (comp === 'Headshot') return 0;
        if (comp === 'Bust') return isRealistic ? 300 : 200;
        if (comp === 'Half Body') return isRealistic ? 400 : 300; 
        if (comp === 'Full Body') return isRealistic ? 600 : 450; 
        return 0; // fallback
    }

    function calculateExtraCharPrice() {
        if (selections.extra_char_type_count === '0') return 0;

        const parts = selections.extra_char_type_count.split('_');
        const compType = parts[0]; 
        const count = parseInt(parts[1]); 
        
        const isRealistic = (selections.style === 'Realistic');
        
        // Uses the new direct function for composition price
        const compAddOn = getPriceForComposition(compType, isRealistic);
        
        const basePrice = priceRules['Extra_Base'];
        // Price = Count * (Base Price + Composition Add-on)
        return count * (basePrice + compAddOn); 
    }

    function calculateItemizedPrices() {
        const items = [];
        let total = 0;

        if (selections.medium === 'Digital') {
            const type = selections.digital_type;
            if (type && priceRules[type]) {
                const price = priceRules[type];
                items.push({ name: `Digital Art: ${type} (Brutalist)`, price: price });
                total += price;
            }
        } else if (selections.medium === 'Traditional') {
            // 1. Base Price 
            const basePrice = getTraditionalBasePrice();
            items.push({ name: 'Traditional Art Base', price: basePrice });
            total += basePrice;
            
            const styleType = selections.style;
            const isRealistic = (styleType === 'Realistic');

            // 2. Paper Size Add-on
            const paperSize = selections.paper_size;
            if (paperSize === 'A3') {
                const price = priceRules['A3_ADDON'];
                items.push({ name: `Paper Size: A3 (+A5 is standard)`, price: price });
                total += price;
            } else if (paperSize === 'A5') {
                items.push({ name: `Paper Size: A5 (Standard)`, price: 0 });
            }
            
            // 3. Style Add-on
            if (styleType && priceRules[styleType]) {
                const price = priceRules[styleType];
                items.push({ name: `Style: ${styleType}`, price: price });
                total += price;
            }

            // 4. Composition Price (Main Character) - USES NEW FUNCTION
            if (selections.style) { 
                const compPrice = getPriceForComposition(selections.comp, isRealistic);
                items.push({ name: `Main Composition: ${selections.comp}`, price: compPrice });
                total += compPrice;
            }
            
            // 5. Finish Price
            let finishPrice = 0;
            let finishName = selections.finish;
            if (selections.finish === 'Colored') finishPrice = priceRules['Colored'];
            else if (selections.finish === 'Shaded') finishPrice = priceRules['Shaded'];
            items.push({ name: `Finish: ${finishName}`, price: finishPrice });
            total += finishPrice;

            // 6. Background Price
            let bgPrice = 0;
            let bgName = selections.bg;
            if (selections.bg === 'Simple') bgPrice = 150;
            else if (selections.bg === 'Detailed') bgPrice = selections.bg_detailed_price;
            items.push({ name: `Background: ${bgName}`, price: bgPrice });
            total += bgPrice;

            // 7. Extra Character Price - USES NEW FUNCTION
            const extraCharPrice = calculateExtraCharPrice(); 
            if (extraCharPrice > 0) {
                const parts = selections.extra_char_type_count.split('_');
                const compType = parts[0];
                const count = parts[1];
                items.push({ name: `Extra Character(s) x${count} (${compType})`, price: extraCharPrice });
                total += extraCharPrice;
            }
            
            // 8. Pet/Object Price
            if (selections.pet_object) {
                items.push({ name: 'Pet / Object', price: selections.pet_object_price });
                total += selections.pet_object_price;
            }
        }

        return { items, total };
    }
    
    function calculateTotalPrice() {
        return calculateItemizedPrices().total;
    }
    
    function updateTotalPriceDisplay() {
        const totalPrice = calculateTotalPrice();
        finalPriceDisplay.textContent = `‚Ç±${totalPrice.toLocaleString()}`;
    }
    
    // üü¢ NEW FUNCTION: Ensures the prices are displayed correctly on the buttons
    function updateCompositionPrices() {
        if (selections.medium !== 'Traditional' || selections.style === null) {
            // Reset to default labels if no selection
            document.querySelectorAll('#composition-options .choice-option').forEach(opt => {
                const compType = opt.dataset.value;
                if (compType === 'Headshot') opt.textContent = 'Headshot (Free)';
                else opt.textContent = `${compType} (+Price Varies)`;
            });
            return;
        }

        const isRealistic = (selections.style === 'Realistic');
        document.querySelectorAll('#composition-options .choice-option').forEach(opt => {
            const compType = opt.dataset.value;
            const price = getPriceForComposition(compType, isRealistic);
            if (price > 0) {
                opt.textContent = `${compType} (+‚Ç±${price.toLocaleString()})`;
            } else {
                opt.textContent = `${compType} (Free)`;
            }
        });
    }
    
    // üü¢ NEW FUNCTION: Ensures extra character dropdown updates accordingly
    function updateExtraCharSelectPrices() {
        if (selections.medium !== 'Traditional' || selections.style === null) return;
        
        const isRealistic = (selections.style === 'Realistic');
        const select = extraCharSelect;
        const extra_base = priceRules['Extra_Base'];
        
        const compPrices = {
            'Headshot': 0,
            'Bust': getPriceForComposition('Bust', isRealistic),
            'Half Body': getPriceForComposition('Half Body', isRealistic),
            'Full Body': getPriceForComposition('Full Body', isRealistic)
        };
        
        for (let i = 1; i < select.options.length; i++) {
            const option = select.options[i];
            const [compType, count] = option.value.split('_');
            const finalPrice = parseInt(count) * (extra_base + compPrices[compType]);
            option.textContent = `${count} Extra Character(s) (${compType}) (+‚Ç±${finalPrice.toLocaleString()})`;
        }
    }


    function createReceiptHTML(items, total) {
        let itemsHTML = items.map(item => `
            <div class="receipt-item">
                <span class="receipt-item-title">${item.name}</span>
                <span class="receipt-item-price">‚Ç±${item.price.toLocaleString()}</span>
            </div>
        `).join('');

        // Calculate PayPal fee if selected
        let paypalFee = 0;
        let finalTotal = total;
        if (selections.payment === 'PayPal') {
            // Standard PayPal fee (approx 4.4% + flat fee) - Using a simple 5% for estimate
            paypalFee = Math.round(total * 0.05);
            finalTotal = total + paypalFee;
            itemsHTML += `
                <div class="receipt-item" style="margin-top: 10px;">
                    <span class="receipt-item-title" style="font-style: italic;">PayPal Fee (Est. 5%)</span>
                    <span class="receipt-item-price" style="font-style: italic;">+‚Ç±${paypalFee.toLocaleString()}</span>
                </div>
            `;
        }

        const noteBox = selections.notes ? `<div class="receipt-note-box">Note: ${selections.notes}</div>` : '';

        return `
            <div class="receipt-header">L√úIS Commission Receipt</div>
            ${itemsHTML}
            <div class="receipt-total">
                <div class="receipt-item">
                    <span>TOTAL ESTIMATE</span>
                    <span style="color: var(--secondary-accent);">‚Ç±${finalTotal.toLocaleString()}</span>
                </div>
            </div>
            ${noteBox}
            <div class="receipt-note-box" style="margin-top: 20px; font-size: 0.8rem; border-left: 3px solid var(--primary-accent);">
                This is only an estimate. Final price may vary slightly after consultation.
                <br>Payment Method: <strong>${selections.payment || 'Not Selected'}</strong>
            </div>
            <a href="mailto:luis@commission.com?subject=Commission Request - Total ‚Ç±${finalTotal.toLocaleString()}" style="display: block; margin-top: 20px; text-decoration: none;">
                <button class="nav-button" style="width: 100%; background-color: var(--primary-accent); border-color: var(--primary-accent); color: var(--accent-text);">SUBMIT REQUEST</button>
            </a>
        `;
    }

    // --- Navigation and State Management ---

    function getNextStep(current, medium) {
        if (current === 1) {
            return medium === 'Digital' ? 3 : 2; // Digital skips to Step 3
        }
        if (current === 2) return 4; // Traditional: 2 (Paper Size) -> 4 (Art Style)
        if (current === 3) return 9; // Digital: 3 (Digital Type) -> 9 (Final Details)
        if (current >= 4 && current < 9) return current + 1; // 4 to 8: Normal flow
        if (current === 9) return 10; // 9 (Final Details) -> 10 (Receipt)
        return totalSteps; // Safety fallback
    }

    function getPrevStep(current, medium) {
        if (current === 1) return 1;
        if (current === 3 && medium === 'Digital') return 1; // Digital 3 -> 1
        if (current === 2) return 1; // Traditional 2 -> 1
        if (current === 4) return 2; // Traditional 4 -> 2
        if (current === 9 && medium === 'Traditional') return 8; // Traditional 9 -> 8
        if (current === 9 && medium === 'Digital') return 3; // Digital 9 -> 3
        if (current === 10) return 9; // 10 (Receipt) -> 9 (Final Details)
        if (current > 1) return current - 1; 
        return 1; // Safety fallback
    }

    function updateNavButtons(current, medium) {
        prevBtn.disabled = current === 1 || current === 10;
        
        // Final button text
        if (current === 9) {
            nextBtn.textContent = 'Generate Receipt ‚Üí';
        } else if (current === 10) {
            nextBtn.textContent = 'Done';
            nextBtn.disabled = true; // No next step after receipt
        } else {
            nextBtn.textContent = 'Next ‚Üí';
            // Disable Next if no selection is made in the current step
            let isSelectionMade = true;
            const activeStepElement = document.querySelector(`.step.active`);
            const type = activeStepElement.querySelector('.choice-option, .styled-select').dataset.type;
            
            if (type === 'medium' && selections.medium === null) isSelectionMade = false;
            if (type === 'paper_size' && selections.paper_size === null) isSelectionMade = false;
            if (type === 'digital_type' && selections.digital_type === null) isSelectionMade = false;
            if (type === 'style' && selections.style === null) isSelectionMade = false;
            if (type === 'comp' && selections.comp === null) isSelectionMade = false;
            if (type === 'finish' && selections.finish === null) isSelectionMade = false;
            if (type === 'bg' && selections.bg === null) isSelectionMade = false;
            
            nextBtn.disabled = !isSelectionMade;
        }
    }
    
    function showStep(stepNumber, direction = 'next') {
        const currentActiveStep = document.querySelector('.step.active');
        const nextStep = document.querySelector(`.step[data-step="${stepNumber}"]`);

        if (currentActiveStep) {
            // Apply slide-out animation to current step
            currentActiveStep.classList.remove('active');
            if (direction === 'next') {
                currentActiveStep.style.transform = 'translateX(-100%)'; // Slide left out
            } else {
                currentActiveStep.style.transform = 'translateX(100%)'; // Slide right out
            }
            currentActiveStep.style.opacity = '0';
        }

        if (nextStep) {
            // Prepare next step position based on direction
            if (direction === 'next') {
                nextStep.style.transform = 'translateX(100%)'; // Start from right
            } else {
                nextStep.style.transform = 'translateX(-100%)'; // Start from left
            }
            nextStep.style.opacity = '0';
            nextStep.style.visibility = 'hidden';
            
            // Wait for transition to finish before changing position and applying slide-in
            setTimeout(() => {
                nextStep.classList.add('active');
                // Apply slide-in animation to next step
                nextStep.style.transform = 'translateX(0)'; // Slide to center
                nextStep.style.opacity = '1';
                nextStep.style.visibility = 'visible';
                
                currentStep = stepNumber;
                stepNumberSpan.textContent = currentStep;
                updateNavButtons(currentStep, selections.medium);
                updateTotalPriceDisplay();

                // Special step logic
                if (currentStep === 9) {
                    updateTotalPriceDisplay();
                } else if (currentStep === 10) {
                    generateReceipt();
                }
            }, 50); // Small delay to ensure CSS applies correctly
        }
    }

    // --- Event Listeners and Initial Setup ---

    // Option Clicks
    allOptions.forEach(option => {
        option.addEventListener('click', function() {
            const type = this.dataset.type;
            const value = this.dataset.value;
            const price = this.dataset.price ? parseInt(this.dataset.price) : null;

            // Clear existing selection for this type
            document.querySelectorAll(`.choice-option[data-type="${type}"]`).forEach(opt => {
                opt.classList.remove('selected');
            });

            // Set new selection
            this.classList.add('selected');
            selections[type] = value;

            // Update complex selections
            if (type === 'medium') {
                selections.paper_size = null; 
                selections.digital_type = null;
                // Reset Traditional-specific choices if switching to Digital
                if (value === 'Digital') {
                    selections.style = null;
                    selections.comp = 'Headshot';
                    selections.finish = 'Lineart';
                    selections.bg = 'None';
                    selections.extra_char_type_count = '0';
                    selections.pet_object = false;
                }
                
            } else if (type === 'bg') {
                if (value === 'Detailed') {
                    bgSliderGroup.style.display = 'block';
                    selections.bg_detailed_price = parseInt(bgSlider.value);
                } else {
                    bgSliderGroup.style.display = 'none';
                    selections.bg_detailed_price = 250; // Reset
                }
            } else if (type === 'extra_pet') {
                if (selections.pet_object === true) {
                    // Deselecting the option (toggle off)
                    selections.pet_object = false;
                    this.classList.remove('selected');
                    petSliderGroup.style.display = 'none';
                } else {
                    // Selecting the option (toggle on)
                    selections.pet_object = true;
                    this.classList.add('selected');
                    petSliderGroup.style.display = 'block';
                    selections.pet_object_price = parseInt(petSlider.value);
                }
            } else if (type === 'style') {
                updateCompositionPrices(); // Update comp prices based on new style
                updateExtraCharSelectPrices(); // Update extra char prices
            }
            
            updateTotalPriceDisplay();
            updateNavButtons(currentStep, selections.medium); // Check if Next can be enabled
        });
    });

    // Slider Listeners
    bgSlider.addEventListener('input', function() {
        bgSliderValue.textContent = this.value;
        selections.bg_detailed_price = parseInt(this.value);
        updateTotalPriceDisplay();
    });

    petSlider.addEventListener('input', function() {
        petSliderValue.textContent = this.value;
        selections.pet_object_price = parseInt(this.value);
        updateTotalPriceDisplay();
    });

    // Dropdown Listener (Extra Character)
    extraCharSelect.addEventListener('change', function() {
        selections.extra_char_type_count = this.value;
        updateTotalPriceDisplay();
    });

    // Navigation Button Actions
    prevBtn.addEventListener('click', () => {
        const prevStep = getPrevStep(currentStep, selections.medium);
        showStep(prevStep, 'prev');
    });

    nextBtn.addEventListener('click', () => {
        if (nextBtn.textContent === 'Generate Receipt ‚Üí') {
            generateReceipt();
            showStep(10, 'next');
        } else {
            const nextStep = getNextStep(currentStep, selections.medium);
            showStep(nextStep, 'next');
        }
    });

    // File Upload Handler (for visual feedback)
    referenceUpload.addEventListener('change', function() {
        if (this.files.length > 0) {
            uploadLabel.textContent = `File selected: ${this.files[0].name}`;
            selections.referenceFile = this.files[0];
        } else {
            uploadLabel.textContent = 'Click here to upload reference file';
            selections.referenceFile = null;
        }
    });

    notesInput.addEventListener('input', function() {
        selections.notes = this.value;
    });

    function generateReceipt() {
        // Hide loading, show receipt paper
        receiptLoading.style.display = 'block';
        finalReceiptPaper.style.display = 'none';
        finalReceiptPaper.innerHTML = '';
        
        setTimeout(() => {
            const { items, total } = calculateItemizedPrices();
            const receiptHTML = createReceiptHTML(items, total);
            
            receiptLoading.style.display = 'none';
            finalReceiptPaper.innerHTML = receiptHTML;
            finalReceiptPaper.style.display = 'block';
            
            // Re-apply animation class to trigger print animation
            finalReceiptPaper.classList.remove('printAnimation'); 
            void finalReceiptPaper.offsetWidth; // Trigger reflow
            finalReceiptPaper.classList.add('printAnimation');
        }, 800); 
    }

    // Initial load setup
    document.addEventListener('DOMContentLoaded', () => {
        showStep(1, 'next'); // Initialize step 1
        updateCompositionPrices(); // Initialize composition prices (will use default Non-Realistic/Non-Style until selected)
        updateExtraCharSelectPrices(); // Initialize extra char dropdown prices
    });
    </script>
</body>
</html>